/**
 * Whisper が無音区間で出力するハルシネーションパターン。
 * 同一フレーズの繰り返しや定型文を検出して除外する。
 *
 * 新しいパターンを追加する場合はこの配列に正規表現を追加してください。
 * 自動評価 (Claude SDK) によるパターン提案も、このファイルに自動追加されます。
 */
export const HALLUCINATION_PATTERNS: RegExp[] = [
  // 日本語の定型的なハルシネーション
  /^(ご視聴ありがとうございました[\s。]*)+$/,
  /^(ありがとうございました[\s。]*)+$/,
  /^(チャンネル登録[をよろしく]?お願いします[\s.]*)+$/,
  /^(チャンネル登録お願いします[\s。]*)+$/,
  /^(チャンネル登録よろしくお願いします[\s.]*)+$/,
  /^(お疲れ様でした[\s.]*)+$/,
  /^(お疲れ様でした(お先失礼します)?[\s.]*)+$/,
  /^(言った後に考えます|ありがとうございます|失礼します|お疲れ様です[\s.]*)+$/,
  /^(おやすみなさい[\s。]*)+$/,
  /^(おわり[\s。]*)+$/,

  // 英語の定型的なハルシネーション
  /^(Thank you for watching[\s.]*)+$/i,
  /^(Thanks for watching[\s.]*)+$/i,
  /^(Subscribe[\s.]*)+$/i,

  // 意味不明な繰り返しパターン
  /^(ティムマクローはこう言ってた[ティムマクローはこう言ってた]+[\s.]*)+$/,
  /^(レベルは死んだ囮のようです[\s.]*)+$/,
  /^(自分の.*?自分の.*?自分の.*?自分の.*?自分の.*?自分の[\s.]*)+$/,
  /^(子がいる(子がいる){4,}|ご視聴ありがとうございました|やめて(やめて){2,}[\s.]*)+$/,
  /^(あ{5,}|お店(お店){5,}[\s.]*)+$/,
  /^((いや){5,}[\s.]*)+$/,
  /^((えっえっ|あっ救急|なぁなんか)[\s.]*)+$/,
  /^((うん){3,}[\s.]*)+$/,
  /^(いったんぽい!\s*)+$/,
  /^(ブー+[\s.]*)+$/,
  /^((ブー){2,}[\s.]*)+$/,
  /^((ブーブー|でこれもっかり|仕組み立っているとも信頼なもあだれ|本気がいい)[\s.]*)+$/,
  /^((?:スパイク成功|応援が必要|北に向かっている|ニカラ活躍業員者|サージェンのシェルドン|オンラインカジノ)[\s.]*)+$/,
  /^((ごめん){5,}[\s.]*)+$/,
  /^((悩み事なかった){5,}[\s.]*)+$/,
  /^((まあ){5,}[\s.]*)+$/,
  /^((ニューパートナーズ){3,}[\s.]*)+$/,

  // 記号のみの出力
  /^(\.+\s*)+$/,

  // 汎用繰り返しノイズパターン: 同じ文字/音節が5回以上連続
  /^(あ{4,}[\s.]*)+$/, // 「あ」が4回以上連続: 無音区間での音声ノイズの誤認識
  /^(い{20,}[\s.]*)+$/, // 「い」が20回以上連続: 音声ノイズ誤認識 (60+回の繰り返しなど)
  /(.)\1{4,}/, // 同じ1文字が5回以上連続 (例: あああああ)
  /(.{2,4})\1{4,}/, // 同じ2-4文字が5回以上連続 (例: 込み込み込み込み込み)
  /^(んん+[\s.]*)+$/, // 繰り返す「ん」(2回以上): 音声ノイズの誤認識
  /^(^ん$[\s.]*)+$/, // 単一の「ん」: 無音区間での音声アーティファクト

  // ソフトウェア用語と動詞の組み合わせハルシネーション
  /^((クロード|スラック|コネクター).*?(使う|設定|参照)[\s.]*)+$/,
  /^((コネクタ|スラック).*?(参照|設定|プラスマーク)[\s.]*)+$/,
  /^((コネクタを参照|スラックがない)[\s.]*)+$/,
  /^((ncb|mcp 自分|パレしたこと)[\s.]*)+$/,
  /^((ありがとうございます|お疲れ様でした).{0,50}(ありがとうございます|お疲れ様でした)[\s.]*)+$/,

  // 疑問文の5回以上の繰り返しハルシネーション
  /^((\S+は\S+ですか\?)\s*){5,}$/,

  // 繰り返し「お、お、お」: ノイズ誤認識による単一文字の繰り返し
  /^(お、お、お[\s.]*)+$/,

  // 意味不明なフレーズの繰り返し: 「デジョン.ハブ」が5回以上連続
  /^((デジョン\.ハブ){5,}[\s.]*)+$/,

  // 12月までの更新パターン: 不自然な繰り返し(例: 12月まで更新12月まで更新されている)
  /^((12月まで更新){2,}[\s.]*)+$/,

  // スポッチャーの過度な繰り返し: 6回以上の繰り返しはノイズの誤認識
  /^(スポッチャー[ですかってあれですね]*(?:スポッチャー[ですかってあれですね]*){4,}[\s.]*)+$/,

  // スケジューラーの繰り返し: 同じ単語の2回以上の繰り返しはノイズの誤認識
  /^(スケジューラー{2,}[\s.]*)+$/,

  // 繰り返し「そうですそうです」と意味不明なフレーズの組み合わせ: ハルシネーション検出
  /^((そうです){4,}|あーりが間違って|うすいさんの[\s.]*)+$/,

  // 劣化音声による意味不明な解釈: 「プレスティック」「ボンディング」と「ん」の組み合わせ
  // 例: 'プレスティックん', 'えっせどこさんの汗', 'ポンプレーズに高いボンディングん'
  /^(([ん]{2,}$|プレスティック|ボンディング)[\s.]*)+$/,

  // 音質低下によるノイズパターン: 「あれあのー」「ブービー」「このフレット」などの組み合わせ
  // 意味のある単語(ロード, スレッド, リーダー)が混在するが、周囲は支離滅裂な破片で構成
  /^((あれあのー|ブービー|このフレット)[\s.]*)+$/,
];

/**
 * テキストがハルシネーションパターンに一致するかを判定する。
 *
 * @param text - 判定対象のテキスト
 * @returns ハルシネーションの場合は true
 */
export function isHallucination(text: string): boolean {
  const trimmed = text.trim();
  if (!trimmed) return true;
  return HALLUCINATION_PATTERNS.some((pattern) => pattern.test(trimmed));
}
