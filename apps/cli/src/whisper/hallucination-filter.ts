/**
 * Whisper が無音区間で出力するハルシネーションパターン。
 * 同一フレーズの繰り返しや定型文を検出して除外する。
 *
 * 新しいパターンを追加する場合はこの配列に正規表現を追加してください。
 * 自動評価 (Claude SDK) によるパターン提案も、このファイルに自動追加されます。
 */
export const HALLUCINATION_PATTERNS: RegExp[] = [
  // ============================================
  // 汎用繰り返しパターン (最初にチェック)
  // ============================================
  // 同じ1文字が5回以上連続 (例: あああああ、んんんんん)
  /(.)\1{4,}/,
  // 同じ2-4文字が5回以上連続 (例: 込み込み込み込み込み、くちゃくちゃくちゃくちゃくちゃ)
  /(.{2,4})\1{4,}/,

  // ============================================
  // 日本語の定型ハルシネーション (YouTube 終了メッセージ系)
  // ============================================
  /^(ご視聴ありがとうございました[\s.。]*)+$/,
  /^(ありがとうございました[\s.。]*)+$/,
  /^(チャンネル登録[をよろしく]*お願いします[\s.。]*)+$/,
  /^(チャンネル登録[よろしく|お願い]します[\s.]*)+$/,
  /^(お疲れ様でした(お先失礼します)?[\s.。]*)+$/,
  /^(おやすみなさい[\s.。]*)+$/,
  /^(おわり[\s.。]*)+$/,

  // ============================================
  // 英語の定型ハルシネーション
  // ============================================
  /^(Thank you for watching[\s.]*)+$/i,
  /^(Thanks for watching[\s.]*)+$/i,
  /^(Subscribe[\s.]*)+$/i,

  // ============================================
  // 記号・ノイズのみの出力
  // ============================================
  /^(\.+\s*)+$/,
  /^(ブー+[\s.]*)+$/,
  // 「ブー」を5回以上繰り返す純粋なノイズ (例: ブーブーブーブーブーブーブーブー)
  /^((ブー){5,}[\s.]*)+$/,

  // ============================================
  // 意味不明なフレーズの繰り返し (汎用パターンでカバーできないもの)
  // ============================================
  // 特定フレーズの組み合わせ
  /^(言った後に考えます|ありがとうございます|失礼します|お疲れ様です[\s.]*)+$/,
  /^(えっえっ|あっ救急|なぁなんか[\s.]*)+$/,
  /^(いったんぽい!\s*)+$/,
  /^(お、お、お[\s.]*)+$/,

  // 意味不明な固有名詞・フレーズ
  /^(ティムマクローはこう言ってた)+$/,
  /^(レベルは死んだ囮のようです[\s.]*)+$/,
  /^(スパイク成功|応援が必要|北に向かっている|ニカラ活躍業員者|サージェンのシェルドン|オンラインカジノ[\s.]*)+$/,
  /^(デジョン\.ハブ[\s.]*)+$/,
  /^(ニューパートナーズ[\s.]*)+$/,
  /^(12月まで更新[\s.]*)+$/,
  /^(スポッチャー[ですかってあれですね]*[\s.]*)+$/,
  /^(あーりが間違って|うすいさんの[\s.]*)+$/,
  /^(プレスティック|ボンディング[\s.]*)+$/,
  /^(あれあのー|ブービー|このフレット[\s.]*)+$/,
  /^(でこれもっかり|仕組み立っているとも信頼なもあだれ|本気がいい[\s.]*)+$/,

  // ソフトウェア用語の誤認識
  /^(ncb|mcp 自分|パレしたこと[\s.]*)+$/,
  /^((クロード|スラック|コネクタ).*?(使う|設定|参照|プラスマーク)[\s.]*)+$/,

  // 挨拶の不自然な繰り返し
  /^((ありがとうございます|お疲れ様でした).{0,50}){2,}$/,
  // 繰り返しする朝の挨拶: 「おはようございます」の連続繰り返し
  // 無音区間での特性的なハルシネーションパターン
  // 例: 「おはようございますおはようございます」, 「おはようございます おはようございます」など
  /^(おはようございます(おはようございます)+[\s.]*)+$/,

  // 疑問文の5回以上の繰り返し
  /^((\S+は\S+ですか\?)\s*){5,}$/,

  // 意味不明なフレーズ: ああそう, ロッパになりん (ハルシネーション誤認識)
  /^(ああそう|ロッパになりん[\s.]*)+$/,

  // 繰り返しノイズ: あああああっ (5+個の "あ" の繰り返し)
  // 無音区間での特性的なノイズパターン
  /^(あああ{3,}[\s.]*)+$/,

  // 繰り返しノイズ: あ{4,} (4個以上の "あ" の繰り返し)
  // 通常会話での連続「あ」は2-3個までが一般的。4個以上は音声処理アーティファクトの強い指標
  /^(あ{4,}[\s.]*)+$/,

  // 複合音繰り返し: おっ{5,} (例: おっっっっっ)
  // 音声ノイズが「おっ」の繰り返しとして誤認識される場合
  /^((おっ){5,}[\s.]*)+$/,

  // 極端なフレーズ繰り返し: していっていっていっ... (5回以上の連続繰り返し)
  // 音声ノイズが特定フレーズとして誤認識される場合
  /^((していっ){5,}[\s.]*)+$/,

  // 「です」の不自然な繰り返し (3回以上)
  // ハルシネーションが「です」を繰り返す傾向がある無音区間を検出
  // 例: 「ですですです」, 「です です です」 など
  /^((です){3,}[\s.]*)+$/,

  // 繰り返しノイズ: 「自分自分」「いいジョブアンテナ」の繰り返し
  // 音声ノイズが繰り返し固有フレーズとして誤認識される場合
  // 例: 「自分自分」「いいジョブアンテナいいジョブアンテナ」など
  /^(自分自分|(?:いいジョブアンテナ){2,}[\s.]*)+$/,

  // 極端なフレーズ繰り返し: 「自分として」の5回以上の連続繰り返し
  // 無音区間での音声ノイズが「自分として」として極端に繰り返される場合
  // 例: 「自分として自分として自分として自分として自分として」など (42+回)
  /^((自分として){5,}[\s.]*)+$/,

  // 繰り返しノイズ: ブーブーパターン
  // 音声ノイズが「ブーブー」として繰り返す場合
  // 例: 「ブーブー ブーブー」, 「ブーブー  ブーブー」など
  /^(ブーブー(\s+ブーブー)+[\s.]*)+$/,
  // 繰り返しノイズ: ブーブー (スペースなし)
  // セグメント 0 と同じ反復音。音声ノイズの誤認識で意味的価値なし
  // 例: 「ブーブーブーブー」など
  /^(ブーブー[\s.]*)+$/,
  // 繰り返しノイズ: (ブーブー){2,}
  // 「ブーブー」が2回以上連続繰り返されるパターン。音声アーティファクトやノイズの誤認識
  // 例: 「ブーブーブーブー」, 「ブーブーブーブーブーブー」など
  /^((ブーブー){2,}[\s.]*)+$/,

  // 繰り返しオノマトペ: ブ・プの短い繰り返し
  // 音声ノイズが「ブ」「プ」の繰り返しとして誤認識される場合 (ブーブー、プププなど)
  // 例: 「ブブ」, 「プププ」, 「ブプブプ」など
  /^([ブプ]{2,}[\s.]*)+$/,

  // 繰り返しノイズ: 「はい」の3回以上の繰り返し
  // 無音区間での音声ノイズが「はい」として誤認識される場合
  // 例: 「はいはいはい」, 「はい はい はい」など
  /^((はい){3,}[\s.]*)+$/,

  // 繰り返しノイズ: 「ん」の3回以上の繰り返し
  // 無音区間での音声ノイズが「ん」として誤認識される場合
  // 例: 「んんん」,「んんんんん」, 「んんん んんん」など
  /^(ん{3,}[\s.]*)+$/,

  // 繰り返しフィラー音: 「んん」以上の繰り返し
  // セマンティック内容なしの繰り返し充填音。背景ノイズや無音の誤認識を特性化
  // 例: 「んん」,「んんん」, 「んん.んん」など
  /^(んん+[\s.]*)+$/,

  // 孤立した「ん」のみ
  // 単一の「ん」は実質的な内容を持たない充填音。複数の言葉を話す際に時々発生しますが、
  // 単独のセグメントとして現れる場合、通常はノイズの誤認識を示しています。
  /^(^ん$[\s.]*)+$/,

  // 繰り返しノイズ: 「うん」の5回以上の繰り返し
  // 無音区間での音声ノイズが「うん」として繰り返す場合
  // 例: 「うんうんうんうんうんうん」など
  /^((うん){5,}[\s.]*)+$/,

  // 意味不明なシラビックの繰り返し: 「オーブンスヘッドレッシュ」
  // 音韻的に一貫性がなく、セマンティック内容を持たない無意味な文字列の繰り返し
  // 例: 「オーブンスヘッドレッシュ」, 「オーブンスヘッドレッシュ オーブンスヘッドレッシュ」など
  /^(オーブンスヘッドレッシュ[\s.]*)+$/,

  // 繰り返しノイズ: 「う」の5個以上の繰り返し
  // 無音区間での音声ノイズが「う」として繰り返される場合 (ううううう など)
  // 例: 「うううううう」, 「ううう ううう」など
  /^(う{5,}[\s.]*)+$/,

  // 繰り返しノイズ: 「ブーブー言っ」の2回以上の繰り返し
  // 特定フレーズの機械的な繰り返しで意味的進展がない。Whisper が音声アーティファクトや無音を誤認識する特性的なパターン
  // 例: 「ブーブー言ってブーブー言った」など
  /^((ブーブー言っ){2,}[\s.]*)+$/,

  // 繰り返しノイズ: ブーブーで始まり不連貫なフレーズが続く
  // 繰り返しノイズ「ブーブー」の後に意味不明な単語が続く複合パターン
  // 文法的に不正な日本語フレーズ。ノイズと幻覚音声の混合
  // 例: 「ブーブーブーブー 何か意味不明な言葉」など
  /^(ブー(ブー)+\s+[\s.]*)+$/,

  // 繰り返しノイズ: 「あ」の8個以上の連続繰り返し
  // 13連続の「あ」のような極端なハルシネーション。ノイズや無音が文字化されたパターン
  // 通常会話では2-3個までが自然。8個以上は間違いなくノイズ誤認識
  // 例: 「あああああああああ」, 「あああああああああ あああああああああ」など
  /^(あ{8,}[\s.]*)+$/,

  // 文脈喪失と不完全な思考: 「うん|まあ|えー」で始まり、疑問形で続き、不完全なフレーズで終わる
  // 極度に支離滅裂なハルシネーション。断片的なフレーズ、不完全な思考、ランダムな単語挿入
  // 例: 「うんなんでこっなんなんで」, 「まあんですかね何まあ」など
  // 文脈喪失とセマンティック崩壊の典型的なハルシネーションパターン
  /^((?:うん|まあ|えー).*?(?:なんで|んですかね|かなと).*?(?:こっなんなんで|何まあ)[\s.]*)+$/,

  // セマンティック崩壊: 不自然な造語・断片フレーズの組み合わせ
  // 無声区間での極度な文脈喪失と文法的協約の喪失。造語的な組み合わせ (のもんん、ながっ、おらないと、とつで)
  // 例: 「創意的ながっ」, 「ちょっと発信終わっておらない」, 「のもんん感じ」など
  /^((?:のもんん|ながっ|おらないと|とつで).*?(?:感じ|かなって)[\s.]*)+$/,

  // 「〇〇の〇〇の〇〇の〇〇」形式の4回以上の繰り返し
  // 無音区間での特性的なハルシネーションパターン
  // 例: 「カードデューティーのカードデューティーのカードデューティーのカードデューティー」
  // 文脈喪失による不自然な繰り返しで意味的価値なし
  /^(([^、。]+)の\1{3,}[\s.]*)+$/,

  // 汎用終了フレーズ: 「以上です」
  // 無音区間での定型的なハルシネーションパターン。通常は会話の終了を示すが、
  // 無音やノイズが誤認識されて頻繁に出現する
  // 例: 「以上です」, 「以上です。」, 「以上です 以上です」など
  /^(以上です[\s.]*)+$/,

  // 繰り返しノイズ: 「ブーバーイメージっ」の繰り返し
  // 意味不明な無意味フレーズの繰り返しで文脈的価値がない。
  // 無音区間での音声アーティファクト誤認識による典型的なハルシネーション
  // 例: 「ブーバーイメージっブーバーイメージっ」など
  /^((ブーバーイメージっ)+[\s.]*)+$/,

  // 繰り返しノイズ: 「バリデーション」と「ユーザー」の繰り返し
  // 開始時は正当な内容だが、段階的に繰り返しハルシネーション化する
  // バリデーション 6回以上、またはユーザー 3回以上の連続繰り返し
  // その後、断片化された ID 参照が続く典型的なパターン
  // 例: 「バリデーションバリデーションバリデーション...ユーザーユーザーユーザー...」など
  /^((?:バリデーション){5,}|(?:ユーザー){3,}[\s.]*)+$/,

  // 繰り返しオノマトペ: ブーぼの繰り返し
  // 意味的内容なし。音声ノイズが「ブーぼ」の繰り返しとして誤認識される場合
  // 例: 「ブーぼブーぼ」, 「ブーぼぼぼ」など
  /^([ブーぼ]+[\s.]*)+$/,

  // 不完全な発話: 小さなひらがな+ ギガ繰り返し+ オプショナルン
  // 無音区間での断片的なハルシネーション。意味を持たない不完全な表現
  // 例: 「いやそんなでもなんか何百ギガン」など
  /^(^[あ-ん]{1,3}[ギガ]{2,}[ン]?$[\s.]*)+$/,

  // 繰り返し意味不明フレーズ: 「んない」の複数繰り返し
  // ノイズと不連貫な音声が組み合わさった複合ハルシネーション
  // 「んない」という3文字単位が複数回繰り返されるパターン
  // 例: 「んないんないんないん」など
  /^(んないんないんないん[\s.]*)+$/,

  // 混合パターン: ノイズ + 音声延長の組み合わせ
  // 「ブーブー言っ」で始まり、5個以上の「あ」が続く複合ハルシネーション
  // Whisper が音声アーティファクトを「ブーブー言っ」として認識し、無音を「ああああああああああああ」として誤認識する場合
  // 例: 「ブーブー言っ あああああああああああああ」など (11+個の「あ」)
  /^(ブーブー言っ\s*あ{5,}[\s.]*)+$/,

  // 意味不明なシラビックの組み合わせ: ぷっぽ + 数字フレーズ + 否定形の複合
  // 無音区間での極度な文脈喪失。連続した意味不明なシラビックと数字を含む破断フレーズ
  // 例: 「ぷっぽぷっぽ100キラ分絶対1万いかないね」など
  // 音声ノイズの組み合わせと不連貫な数値表現が混在したハルシネーション
  /^((?:[ぷっぽ]{1,}|100[キギ]+分|絶対[数字]+いかない)[\s.]*)+$/,

  // 変形された技術用語: ベースプライス、チレンター、スキラーなど
  // 無音区間でのWhisper幻覚。実在しない造語の繰り返し。
  // これらは音声ノイズが実在しない技術用語として誤認識される典型的なパターン
  // 例: 「ベースプライスチレンター」, 「スキラー選べるに動員」など
  /^((?:ベースプライス|チレンター|スキラー|選べるに動員)[\s.]*)+$/,

  // 繰り返しパターン: 「1万円」の5回以上の繰り返し
  // 明確なハルシネーション: 「1万円」が50回以上連続して繰り返される
  // 通常会話では起こりえない極端な数値フレーズの繰り返し。
  // 無音区間での音声アーティファクトがフレーズ単位で極端に繰り返される典型的なパターン
  // 例: 「1万円1万円1万円...」（50回以上）
  /^(1万円([\s]*1万円){4,}[\s.]*)+$/,
];

/**
 * テキストがハルシネーションパターンに一致するかを判定する。
 *
 * @param text - 判定対象のテキスト
 * @returns ハルシネーションの場合は true
 */
export function isHallucination(text: string): boolean {
  const trimmed = text.trim();
  if (!trimmed) return true;
  return HALLUCINATION_PATTERNS.some((pattern) => pattern.test(trimmed));
}
