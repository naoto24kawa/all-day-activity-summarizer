/**
 * Whisper が無音区間で出力するハルシネーションパターン。
 * 同一フレーズの繰り返しや定型文を検出して除外する。
 *
 * 新しいパターンを追加する場合はこの配列に正規表現を追加してください。
 * 自動評価 (Claude SDK) によるパターン提案も、このファイルに自動追加されます。
 *
 * パターンは優先度順に配置されています (汎用 → 具体)。
 * 汎用パターンで早期マッチすることでパフォーマンスを向上させています。
 */
export const HALLUCINATION_PATTERNS: RegExp[] = [
  // ============================================
  // Tier 1: 汎用繰り返しパターン (最優先)
  // ============================================
  // 同じ1文字が5回以上連続 (例: あああああ、んんんんん)
  /(.)\1{4,}/,
  // 同じ2-4文字が5回以上連続 (例: 込み込み込み込み込み)
  /(.{2,4})\1{4,}/,

  // ============================================
  // Tier 2: ノイズパターン (ブーブー系)
  // ============================================
  // 「ブー」「ブーブー」の繰り返し (全バリエーション統合)
  /^(ブー+[\s.]*)+$/,
  // 「ブ」「プ」の短い繰り返し
  /^([ブプ]{2,}[\s.]*)+$/,
  // 「ブーバー」パターン
  /^ブーバー[\s.]*$/,
  // ブーブー + あ繰り返し (複合ノイズ)
  /^ブーブー[\s.]*あ{5,}[\s.]*$/,
  // ブーブーで挟まれたコンテンツ
  /^ブーブー.+ブーブー[\s.]*$/,

  // ============================================
  // Tier 3: フィラー音・単一音の繰り返し
  // ============================================
  // 孤立した「ん」のみ
  /^ん[\s.]*$/,
  // 孤立した「あ」とカンマの短い繰り返し (例: あ、あ、あ)
  /^[あ、]+([\s.]*[あ、]+)*[\s.]*$/,
  // 「ふん」の5回以上繰り返し (複合ユニット)
  /^(ふん(ふん){4,}[\s.]*)+$/,
  // 「ふん、ふん」の形式 (カンマで区切った2回以上の繰り返し)
  /^(^ふん(、ふん)+$[\s.]*)+$/,
  // 「ふんふんふん」の極端な繰り返し (8+ 回) - 意味不明なシラビック繰り返し
  /^(^ふんふんふん+[\s.]*)+$/,
  // 「ふ」「ん」の繰り返し (5回以上) - 繰り返し文字ノイズ
  /^[ふん]{5,}[\s.]*$/,
  // 「ふ」「ん」の繰り返し (12回以上) - 無音区間でのハルシネーション
  /^[ふん]{12,}[\s.]*$/,
  // 「ふん」の極端な繰り返し (100+ 回) - 無音区間での大量ハルシネーション
  /^(ふ+ん+[\s.]*)+$/,
  // 「ふっふ」の繰り返し (3回以上) - リズミカルな無音区間ハルシネーション
  /^(ふ(っふ){3,}[\s.]*)+$/,
  // 「ふんふん」の過度な繰り返し (20回以上) - 無音区間での定型フィラー
  /^(ふんふん[\s.]*){20,}$/,
  // 「ふん」の20回以上の繰り返し - 無音区間での継続的なハルシネーション
  /^(ふん[\s.]*){20,}$/,
  // 「ふん」の極端な繰り返し (50回以上) - 無音で単純反復された長いハルシネーション
  /^(ふん[\s.]*){50,}$/,
  // 「はい」「うん」の不自然な繰り返し (3回以上)
  /^(はい[\s]*){3,}$/,
  /^(うん[\s]*){5,}$/,
  // 「あっはぁ」の交互繰り返し
  /^(あっ|はぁ){3,}[\s.]*$/,
  // 「おっ」の繰り返し
  /^(おっ){5,}[\s.]*$/,
  // 「はっ」の極端な繰り返し
  /^はっ{5,}[\s.]*$/,

  // ============================================
  // Tier 4: 日本語定型ハルシネーション
  // ============================================
  // YouTube 終了メッセージ系
  /^(ご視聴ありがとうございました[\s.。]*)+$/,
  /^(ありがとうございました[\s.。]*)+$/,
  /^(チャンネル登録(よろしく|を)?お願いします[\s.。]*)+$/,
  /^(お疲れ様でした(お先失礼します)?[\s.。]*)+$/,
  /^(おやすみなさい[\s.。]*)+$/,
  /^(おわり[\s.。]*)+$/,
  /^(以上です[\s.。]*)+$/,
  // 挨拶の繰り返し (2回以上)
  /^(おはようございます[\s]*){2,}$/,
  // 「こんばんは」の繰り返し (4回以上)
  /^(こんばんは[。、]*こんばんは[。、]*こんばんは[。、]*こんばんは[\s.]*)+$/,
  // 「ありがとうございます」の繰り返し + 断片的フィラー (「あっ」含む)
  /^(ありがとうございます{2,}|あっ\s+ありがとうございます[\s.]*)+$/,
  // 挨拶フレーズの不自然な繰り返し
  /^(ありがとうございます|お疲れ様でした|失礼します|お疲れ様です)(.{0,30}(ありがとうございます|お疲れ様でした|失礼します|お疲れ様です))+$/,

  // ============================================
  // Tier 5: 英語定型ハルシネーション
  // ============================================
  /^(Thank(s| you)? for watching[\s.]*)+$/i,
  /^(Subscribe[\s.]*)+$/i,

  // ============================================
  // Tier 6: 記号・ノイズのみ
  // ============================================
  /^(\.+\s*)+$/,
  // 繰り返しの句読点 (、・) - OCR または無音区間ノイズ
  /^(^[、・\s]+$[\s.]*)+$/,
  // 純粋な句読点とドットのみ - 無音区間やOCR破損
  /^(^[、・\s.]+$[\s.]*)+$/,

  // ============================================
  // Tier 7: 意味不明フレーズ (個別)
  // ============================================
  // 特定の意味不明な固有名詞・フレーズ
  /^(^ふんっ、?$[\s.]*)+$/,
  /^(ティムマクローはこう言ってた)+$/,
  /^(レベルは死んだ囮のようです[\s.]*)+$/,
  /^(デジョン\.ハブ[\s.]*)+$/,
  /^(ニューパートナーズ[\s.]*)+$/,
  /^(オーブンスヘッドレッシュ[\s.]*)+$/,
  /^(いったんぽい!\s*)+$/,

  // ゲーム・広告系の誤認識
  /^(スパイク成功|応援が必要|北に向かっている|オンラインカジノ[\s.]*)+$/,

  // 技術用語の誤認識
  /^(ベースプライス|チレンター|スキラー)+[\s.]*$/,

  // 意味不明なシラビック
  /^(えっえっ|あっ救急|なぁなんか[\s.]*)+$/,
  /^(お、お、お[\s.]*)+$/,
  /^(ああそう|ロッパになりん[\s.]*)+$/,
  /^(自分自分|いいジョブアンテナ[\s.]*)+$/,

  // ============================================
  // Tier 8: 複合パターン (構造的ハルシネーション)
  // ============================================
  // 疑問文の5回以上の繰り返し
  /^((\S+は\S+ですか\?)\s*){5,}$/,

  // 「X の X の X の X」形式 (4回以上)
  /^([^、。]+)(の\1){3,}[\s.]*$/,

  // 文脈喪失パターン (断片的フレーズの組み合わせ)
  /^(うん|まあ|えー).*(なんで|んですかね).*(こっなんなんで|何まあ)[\s.]*$/,

  // ============================================
  // Tier 9: 特定フレーズの極端な繰り返し
  // ============================================
  // 「1万円」の5回以上繰り返し
  /^(1万円[\s]*){5,}$/,

  // 「ジョブアンテナー」の5回以上繰り返し
  /^(ジョブアンテナー[\s]*){5,}$/,

  // 日本語文字の極端な繰り返し (汎用)
  // 例: ジョブアンテナー12回、その他フレーズの多数繰り返し
  /^(([ぁ-ん一-龯ァ-ヴー・々〆〤ー]+)\2{4,}[\s.]*)+$/,

  // 「自分として」の5回以上繰り返し
  /^(自分として[\s]*){5,}$/,

  // 「バリデーション」「ユーザー」の極端な繰り返し
  /^(バリデーション[\s]*){5,}$/,
  /^(ユーザー[\s]*){3,}$/,

  // 「していっ」の極端な繰り返し
  /^(していっ[\s]*){5,}$/,

  // 「ブーブー言っ」の繰り返し
  /^(ブーブー言っ[\s]*){2,}$/,

  // 「パーソナル」の極端な繰り返し (スペース区切り, 31+ 文字)
  // 例: 「パーソナル パーソナル パーソナル...」(5回以上)
  // 無音区間での単語の無限ループハルシネーション
  /^(パーソナル(\sパーソナル){5,}[\s.]*)+$/,

  // 「ギット」の中点区切り繰り返し
  // 例: 「・ギット・ギット・ギット・ギット」などの
  /^・?ギット(・ギット)*[\s.]*$/,

  // 「てるやん、」の極端な繰り返し (30+ 回)
  // 無音区間での意味不明フレーズの大量繰り返し
  /^([てるやん、\s]+[\s.]*)+$/,

  // ============================================
  // Tier 10: 極端な単一文字繰り返し (80+ 回)
  // ============================================
  // 「あ」とカンマの過度な繰り返し (20+ 文字単位で複数回)
  // 例: あ、あ、あ、あ、... (80+ 文字連続)
  /^([あ、]{20,}[\s.]*)+$/,

  // 拗音 (ぅ、ぇ、ぉ) の長時間連続繰り返し
  // 例: あさってはいらっしゃるぅ + ぅぅぅぅ... (80+ 文字連続)
  // Whisper による無音区間での伸ばし音ハルシネーション
  /^([ぅぇぉ]{20,}|[ぁ-ん]([ぅぇぉ])\2{15,}[\s.]*)+$/,

  // 「え」の20回以上繰り返し
  // 例: 「ああ、ちょっとまた 笹子さんに つつかれるかもしれんですねえ」→ 無音でハルシネーション
  // Whisper が無音区間で「え」のみを100+回繰り返す場合
  /^(え{20,}[\s.]*)+$/,
];

/**
 * テキストがハルシネーションパターンに一致するかを判定する。
 *
 * @param text - 判定対象のテキスト
 * @returns ハルシネーションの場合は true
 */
export function isHallucination(text: string): boolean {
  const trimmed = text.trim();
  if (!trimmed) return true;
  return HALLUCINATION_PATTERNS.some((pattern) => pattern.test(trimmed));
}
