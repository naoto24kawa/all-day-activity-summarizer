/**
 * Whisper が無音区間で出力するハルシネーションパターン。
 * 同一フレーズの繰り返しや定型文を検出して除外する。
 *
 * 新しいパターンを追加する場合はこの配列に正規表現を追加してください。
 * 自動評価 (Claude SDK) によるパターン提案も、このファイルに自動追加されます。
 */
export const HALLUCINATION_PATTERNS: RegExp[] = [
  // 日本語の定型的なハルシネーション
  /^(ご視聴ありがとうございました[\s。]*)+$/,
  /^(ありがとうございました[\s。]*)+$/,
  /^(チャンネル登録お願いします[\s。]*)+$/,
  /^(お疲れ様でした[\s.]*)+$/,
  /^(おやすみなさい[\s。]*)+$/,

  // 英語の定型的なハルシネーション
  /^(Thank you for watching[\s.]*)+$/i,
  /^(Thanks for watching[\s.]*)+$/i,
  /^(Subscribe[\s.]*)+$/i,

  // 意味不明な繰り返しパターン
  /^(ティムマクローはこう言ってた[ティムマクローはこう言ってた]+[\s.]*)+$/,
  /^(レベルは死んだ囮のようです[\s.]*)+$/,
  /^(自分の.*?自分の.*?自分の.*?自分の.*?自分の.*?自分の[\s.]*)+$/,
  /^(子がいる(子がいる){4,}|ご視聴ありがとうございました|やめて(やめて){2,}[\s.]*)+$/,
  /^(あ{5,}|お店(お店){5,}[\s.]*)+$/,
  /^((いや){5,}[\s.]*)+$/,
  /^(いったんぽい!\s*)+$/,
  /^(^ブー+$[\s.]*)+$/,
  /^((ブーブー|でこれもっかり|仕組み立っているとも信頼なもあだれ|本気がいい)[\s.]*)+$/,
  /^((?:スパイク成功|応援が必要|北に向かっている|ニカラ活躍業員者|サージェンのシェルドン|オンラインカジノ)[\s.]*)+$/,
  /^((ごめん){5,}[\s.]*)+$/,
  /^((悩み事なかった){5,}[\s.]*)+$/,

  // 記号のみの出力
  /^(\.+\s*)+$/,

  // 汎用繰り返しノイズパターン: 同じ文字/音節が5回以上連続
  /(.)\1{4,}/, // 同じ1文字が5回以上連続 (例: あああああ)
  /(.{2,4})\1{4,}/, // 同じ2-4文字が5回以上連続 (例: 込み込み込み込み込み)

  // ソフトウェア用語と動詞の組み合わせハルシネーション
  /^((クロード|スラック|コネクター).*?(使う|設定|参照)[\s.]*)+$/,
  /^((コネクタ|スラック).*?(参照|設定|プラスマーク)[\s.]*)+$/,
  /^((コネクタを参照|スラックがない)[\s.]*)+$/,
];

/**
 * テキストがハルシネーションパターンに一致するかを判定する。
 *
 * @param text - 判定対象のテキスト
 * @returns ハルシネーションの場合は true
 */
export function isHallucination(text: string): boolean {
  const trimmed = text.trim();
  if (!trimmed) return true;
  return HALLUCINATION_PATTERNS.some((pattern) => pattern.test(trimmed));
}
