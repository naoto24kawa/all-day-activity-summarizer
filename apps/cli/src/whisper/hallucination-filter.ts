/**
 * Whisper が無音区間で出力するハルシネーションパターン。
 * 同一フレーズの繰り返しや定型文を検出して除外する。
 *
 * 新しいパターンを追加する場合はこの配列に正規表現を追加してください。
 * 自動評価 (Claude SDK) によるパターン提案も、このファイルに自動追加されます。
 */
export const HALLUCINATION_PATTERNS: RegExp[] = [
  // ============================================
  // 汎用繰り返しパターン (最初にチェック)
  // ============================================
  // 同じ1文字が5回以上連続 (例: あああああ、んんんんん)
  /(.)\1{4,}/,
  // 同じ2-4文字が5回以上連続 (例: 込み込み込み込み込み、くちゃくちゃくちゃくちゃくちゃ)
  /(.{2,4})\1{4,}/,

  // ============================================
  // 日本語の定型ハルシネーション (YouTube 終了メッセージ系)
  // ============================================
  /^(ご視聴ありがとうございました[\s.。]*)+$/,
  /^(ありがとうございました[\s.。]*)+$/,
  /^(チャンネル登録[をよろしく]*お願いします[\s.。]*)+$/,
  /^(チャンネル登録[よろしく|お願い]します[\s.]*)+$/,
  /^(お疲れ様でした(お先失礼します)?[\s.。]*)+$/,
  /^(おやすみなさい[\s.。]*)+$/,
  /^(おわり[\s.。]*)+$/,

  // ============================================
  // 英語の定型ハルシネーション
  // ============================================
  /^(Thank you for watching[\s.]*)+$/i,
  /^(Thanks for watching[\s.]*)+$/i,
  /^(Subscribe[\s.]*)+$/i,

  // ============================================
  // 記号・ノイズのみの出力
  // ============================================
  /^(\.+\s*)+$/,
  /^(ブー+[\s.]*)+$/,
  // 「ブー」を5回以上繰り返す純粋なノイズ (例: ブーブーブーブーブーブーブーブー)
  /^((ブー){5,}[\s.]*)+$/,

  // ============================================
  // 意味不明なフレーズの繰り返し (汎用パターンでカバーできないもの)
  // ============================================
  // 特定フレーズの組み合わせ
  /^(言った後に考えます|ありがとうございます|失礼します|お疲れ様です[\s.]*)+$/,
  /^(えっえっ|あっ救急|なぁなんか[\s.]*)+$/,
  /^(いったんぽい!\s*)+$/,
  /^(お、お、お[\s.]*)+$/,

  // 意味不明な固有名詞・フレーズ
  /^(ティムマクローはこう言ってた)+$/,
  /^(レベルは死んだ囮のようです[\s.]*)+$/,
  /^(スパイク成功|応援が必要|北に向かっている|ニカラ活躍業員者|サージェンのシェルドン|オンラインカジノ[\s.]*)+$/,
  /^(デジョン\.ハブ[\s.]*)+$/,
  /^(ニューパートナーズ[\s.]*)+$/,
  /^(12月まで更新[\s.]*)+$/,
  /^(スポッチャー[ですかってあれですね]*[\s.]*)+$/,
  /^(あーりが間違って|うすいさんの[\s.]*)+$/,
  /^(プレスティック|ボンディング[\s.]*)+$/,
  /^(あれあのー|ブービー|このフレット[\s.]*)+$/,
  /^(でこれもっかり|仕組み立っているとも信頼なもあだれ|本気がいい[\s.]*)+$/,

  // ソフトウェア用語の誤認識
  /^(ncb|mcp 自分|パレしたこと[\s.]*)+$/,
  /^((クロード|スラック|コネクタ).*?(使う|設定|参照|プラスマーク)[\s.]*)+$/,

  // 挨拶の不自然な繰り返し
  /^((ありがとうございます|お疲れ様でした).{0,50}){2,}$/,

  // 疑問文の5回以上の繰り返し
  /^((\S+は\S+ですか\?)\s*){5,}$/,

  // 意味不明なフレーズ: ああそう, ロッパになりん (ハルシネーション誤認識)
  /^(ああそう|ロッパになりん[\s.]*)+$/,

  // 繰り返しノイズ: あああああっ (5+個の "あ" の繰り返し)
  // 無音区間での特性的なノイズパターン
  /^(あああ{3,}[\s.]*)+$/,

  // 複合音繰り返し: おっ{5,} (例: おっっっっっ)
  // 音声ノイズが「おっ」の繰り返しとして誤認識される場合
  /^((おっ){5,}[\s.]*)+$/,

  // 極端なフレーズ繰り返し: していっていっていっ... (5回以上の連続繰り返し)
  // 音声ノイズが特定フレーズとして誤認識される場合
  /^((していっ){5,}[\s.]*)+$/,

  // 「です」の不自然な繰り返し (3回以上)
  // ハルシネーションが「です」を繰り返す傾向がある無音区間を検出
  // 例: 「ですですです」, 「です です です」 など
  /^((です){3,}[\s.]*)+$/,

  // 繰り返しノイズ: 「自分自分」「いいジョブアンテナ」の繰り返し
  // 音声ノイズが繰り返し固有フレーズとして誤認識される場合
  // 例: 「自分自分」「いいジョブアンテナいいジョブアンテナ」など
  /^(自分自分|(?:いいジョブアンテナ){2,}[\s.]*)+$/,

  // 繰り返しノイズ: ブーブーパターン
  // 音声ノイズが「ブーブー」として繰り返す場合
  // 例: 「ブーブー ブーブー」, 「ブーブー  ブーブー」など
  /^(ブーブー(\s+ブーブー)+[\s.]*)+$/,

  // 繰り返しノイズ: 「はい」の3回以上の繰り返し
  // 無音区間での音声ノイズが「はい」として誤認識される場合
  // 例: 「はいはいはい」, 「はい はい はい」など
  /^((はい){3,}[\s.]*)+$/,

  // 繰り返しノイズ: 「ん」の3回以上の繰り返し
  // 無音区間での音声ノイズが「ん」として誤認識される場合
  // 例: 「んんん」,「んんんんん」, 「んんん んんん」など
  /^(ん{3,}[\s.]*)+$/,

  // 孤立した「ん」のみ
  // 単一の「ん」は実質的な内容を持たない充填音。複数の言葉を話す際に時々発生しますが、
  // 単独のセグメントとして現れる場合、通常はノイズの誤認識を示しています。
  /^(^ん$[\s.]*)+$/,
];

/**
 * テキストがハルシネーションパターンに一致するかを判定する。
 *
 * @param text - 判定対象のテキスト
 * @returns ハルシネーションの場合は true
 */
export function isHallucination(text: string): boolean {
  const trimmed = text.trim();
  if (!trimmed) return true;
  return HALLUCINATION_PATTERNS.some((pattern) => pattern.test(trimmed));
}
